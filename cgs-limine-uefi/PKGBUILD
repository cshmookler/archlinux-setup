preprocess() {
    sudo -E bash -uec "echo \"$(cat $1)\""
}

pkgname="cgs-limine-uefi"
pkgver="20240102"
pkgrel=1
pkgdesc="Pacman hook and configuration for limine"
arch=("any")
depends=("limine" "efibootmgr")

package() {
    export SETUP_BOOT_LOADER_DIR=/boot/limine
    export SETUP_DISK_ROOT=$(df -P / | awk 'END{print $1}')
    mkdir -p $pkgdir/$SETUP_BOOT_LOADER_DIR/
    mkdir -p $pkgdir/etc/pacman.d/hooks/
    export SETUP_DISK_EFI=$(df -P /boot | awk 'END{print $1}')
    preprocess $startdir/liminedeploy-uefi.hook >$pkgdir/etc/pacman.d/hooks/liminedeploy.hook
    preprocess $startdir/limine.cfg >$pkgdir/$SETUP_BOOT_LOADER_DIR/limine.cfg
    efibootmgr --create --disk $SETUP_DISK_EFI --loader /BOOTX64.EFI --label "Arch Linux" --unicode
    sudo pacman -S --noconfirm limine # Run the installation hook
}
